---
layout:     post
title:      Servlet
subtitle:   Servlet
date:       2019-12-09
author:     正版慕言
header-img: img/blog_bg_1.jpg
catalog: true
mathjax: true
tags:
    - Java
    - Servlet

---

> Servlet是JavaWeb的三大组件(Servlet, Filter, Listener)之一，属于动态资源。作用是处理服务器接收到的请求。

Servlet中通常需要：
- 接收请求数据
- 处理请求
- 完成响应

# Servlet接口

**实现Servlet的方式**
- 实现javax.servlet.Servlet接口
- 继承javax.servlet.GenericServlet类
- 继承javax.servlet.http.HttpServlet类

通常会继承HTTPServlet类来完成。

Servlet接口定义
```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

package javax.servlet;

import java.io.IOException;

public interface Servlet {
    //生命周期方法，可调用一次
    void init(ServletConfig var1) throws ServletException;
    //获取Servlet配置信息
    //一个ServletConfig对象对应了web.xml中一个Servlet的配置信息
    ServletConfig getServletConfig();
    //生命周期方法，可调用多次
    //每一次请求的处理都调用这个方法
    void service(ServletRequest var1, ServletResponse var2) throws ServletException, IOException;
    //获取Servlet信息
    String getServletInfo();
    //生命周期方法，可调用一次
    void destroy();
}
```

通常其中的方法多数(生命周期方法)由Tomcat来调用，对象也由Tomcat来创建。

生命周期方法：
- void init(ServletConfig var1) 创建时立刻执行
- void service(ServletRequest var1, ServletResponse var2) 每次处理请求时被调用
- void destroy() 销毁时执行

**Servlet特性：**
- 遵循单例模式
- 效率高，线程不安全
    + 尽量不要创建成员，使用局部变量即可
    + 可创建无状态成员或只读状态的成员

在web.xml中可以配置<load-on-startup>num</load-on-startup>，num为一个非负数的值。让服务器在启动时就创建Servlet。多个Servlet按照num从小到大的顺序创建。

一个Servlet可以给出多个<url-patern></url-patern>

# ServletConfig接口

ServletConfig接口定义
```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

package javax.servlet;

import java.util.Enumeration;

public interface ServletConfig {
    //获得<servlet-name>中的内容
    String getServletName();
    //获取Servlet上下文对象
    ServletContext getServletContext();
    //通过名称获取指定初始化参数的值
    String getInitParameter(String var1);
    //获取所有初始化参数的名称
    Enumeration<String> getInitParameterNames();
}

```

案例
```java
package com.lsbmzzz;

import javax.servlet.*;
import java.io.IOException;
import java.util.Enumeration;

public class Demo1 implements Servlet {
    @Override
    public void init(ServletConfig servletConfig) throws ServletException {
        System.out.println("init");
        System.out.println(servletConfig.getInitParameter("p1"));
        Enumeration enumeration = servletConfig.getInitParameterNames();
        while(enumeration.hasMoreElements())
            System.out.println(enumeration.nextElement());

    }

    @Override
    public ServletConfig getServletConfig() {
        return null;
    }

    @Override
    public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws ServletException, IOException {
        System.out.println("service");

    }

    @Override
    public String getServletInfo() {
        return null;
    }

    @Override
    public void destroy() {
        System.out.println("destory");
    }
}

```

# GenericServlet类

Servlet接口的抽象类，为Servlet接口中的一些方法做了空实现，只将service()方法作为抽象方法。

```java
//
// Source code recreated from a .class file by IntelliJ IDEA
// (powered by Fernflower decompiler)
//

package javax.servlet;

import java.io.IOException;
import java.io.Serializable;
import java.util.Enumeration;
import java.util.ResourceBundle;

public abstract class GenericServlet implements Servlet, ServletConfig, Serializable {
    private static final String LSTRING_FILE = "javax.servlet.LocalStrings";
    private static ResourceBundle lStrings = ResourceBundle.getBundle("javax.servlet.LocalStrings");
    private transient ServletConfig config;

    public GenericServlet() {
    }

    public void destroy() {
    }

    public String getInitParameter(String name) {
        ServletConfig sc = this.getServletConfig();
        if (sc == null) {
            throw new IllegalStateException(lStrings.getString("err.servlet_config_not_initialized"));
        } else {
            return sc.getInitParameter(name);
        }
    }

    public Enumeration<String> getInitParameterNames() {
        ServletConfig sc = this.getServletConfig();
        if (sc == null) {
            throw new IllegalStateException(lStrings.getString("err.servlet_config_not_initialized"));
        } else {
            return sc.getInitParameterNames();
        }
    }

    public ServletConfig getServletConfig() {
        return this.config;
    }

    public ServletContext getServletContext() {
        ServletConfig sc = this.getServletConfig();
        if (sc == null) {
            throw new IllegalStateException(lStrings.getString("err.servlet_config_not_initialized"));
        } else {
            return sc.getServletContext();
        }
    }

    public String getServletInfo() {
        return "";
    }

    public void init(ServletConfig config) throws ServletException {
        this.config = config;
        this.init();
    }

    public void init() throws ServletException {
    }

    public void log(String msg) {
        this.getServletContext().log(this.getServletName() + ": " + msg);
    }

    public void log(String message, Throwable t) {
        this.getServletContext().log(this.getServletName() + ": " + message, t);
    }

    public abstract void service(ServletRequest var1, ServletResponse var2) throws ServletException, IOException;

    public String getServletName() {
        ServletConfig sc = this.getServletConfig();
        if (sc == null) {
            throw new IllegalStateException(lStrings.getString("err.servlet_config_not_initialized"));
        } else {
            return sc.getServletName();
        }
    }
}
```

# HttpServlet

只需覆写doGet()和doPost()方法。

[HttpServlet时序图](/img/Java开发/HttpServlet时序图.png)

# ServletContext

> **一个项目只有一个ServletContext对象**
> 
> 可以在N个Servlet中获取这个唯一对象，可以用它给多个Servlet传递数据。
> 
> 在Tomcat启动时创建，Tomcat关闭时才结束。

#### 获取ServletContext

**使用ServletConfig提供的getServletContext()方法**
- GenericServlet或HttpServlet类getServletConfig().getServletContext()方法(该实现了ServletConfig接口)
- 在init(ServleetConfig servletConfig)方法中获得
- ...

#### 操作域属性

JavaWeb的四大域对象：
- PageContext
- ServletRequest
- HttpSession
- ServletContext

所有域对象都有存取数据的功能，其中有一个Map用来存储数据。

ServletContext是JavaWeb四大域对象之一。

ServletContext操作数据的方法：

|方法|功能|
|---|---|
|void setAttribute(String name, Object value)|存储一个对象(域属性)|
|Object getAttribute(String name)|获取数据|
|void removeAttribute(String name)|溢出域属性|
|Enumeration getAttributeNames()|获取所有域属性的名称|

#### 获取应用初始化参数

一个Servlet只能获取自己的初始化参数，不能获取其他Servlet的参数。

可以配置公共的初始化参数供所有Servlet使用，这需要使用ServletContext。
- ServletConfig中提供的方法
    + String getInitParameter(String var1);
    + Enumeration<String> getInitParameterNames();

#### 获取资源

- 获取真实路径
    + ServletContext提供的String getRealPath(String var1)方法
- 获取资源流
    + ServletContext提供的InputStream getResourceAsStream(String var1)方法
- 获取指定目录下所有资源路径
    + ServletContext提供的Set<String> getResourcePaths(String var1)方法

以上所有方法中填写的都应是资源在项目中的绝对路径
