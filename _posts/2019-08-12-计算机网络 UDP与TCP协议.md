---
layout:     post
title:      计算机网络 UDP与TCP协议
subtitle:   计算机网络 UDP与TCP协议
date:       2019-08-14
author:     正版慕言
header-img: img/blog_bg_4.jpg
catalog: true
tags:
    - 计算机网络
    - UDP与TCP

---

> Internet的传输层主要有UDP和TCP两个协议，UDP是无连接协议，TCP是面向连接的协议，两个协议互为补充。

## TCP与UDP的区别

UDP在传送数据前不需要先建立连接，远地主机在收到UDP报文后不需要给出任何确认消息。在某些情况下，UDP是一种最有效的工作方式。
TCP提供面向连接的服务，在数据传送前必须先建立连接，数据传送结束后要释放连接。由于TCP提供的是可靠的、面向连接的传输服务，因此不可避免的增加了很多开销。
![f6ef55a46c28c0fb9d94d1bf142c07c1.png](/img/ComputerNetworks/计算机网络-各种应用和应用层协议使用的传输层协议)

## 用户数据报协议UDP

#### UDP协议的特点：

* UDP是无连接的
* UDP不保证可靠交付，因此主机不需要维持复杂的连接状态。
* UDP是面向报文的。发送方的UDP对应用程序送来的报文添加首部后就交付给IP层，对报文不做合并或拆分。
* UDP没有拥塞控制，保证了应用的实时性。
* UDP支持一对一、一对多、多对一和多对多的交互通信。
* UDP的首部开销小，只有8个字节，而TCP要20个字节。
![afed5daa4a20a631c9edb29de047b486.png](/img/ComputerNetworks/计算机网络-UDP的头格式.png)
首部和伪首部：
![9e1383855cda02bf16afa1358d7fb92d.png](/img/ComputerNetworks/计算机网络-UDP的首部和伪首部.png)
伪首部不是真正的首部，只是在计算检验和时临时添加的，用于计算检验和。既不向下传送也不向上递交。

#### UDP的典型应用：

* 需要简单的请求-响应通信，而较少考虑流量控制和差错控制的进程。
* 具有内部流量控制和差错控制机制的进程，如简单文件传输协议TFTP
* 多播的情况
* UDP常用于交互实时应用，避免接收报文之间的不一致延时
* 可用于管理进程，例如SNMP

## 传输控制协议TCP

#### TCP的主要特点：

* TCP是面向连接的传输层协议。应用程序在使用TCP之前必须先建立TCP连接，传送完毕后要释放连接。
* TCP连接是点对点的。
* TCP提供可靠交付的服务，保证传送的数据无差错、不丢失、不重复、按序到达。
* 提供全双工通信。允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，临时存放通信数据。
* 面向字节流。TCP的交互虽然是一次一个数据块，但把应用程序交付下来的数据看做字节流。TCP不保证接收方应用程序收到的数据块和发送方应用程序发出的数据块具有对应大小的关系，但字节流必须完全一样。

#### TCP的连接
TCP连接的端点叫做套接字。套接字的格式：
```
套接字Socket = (IP地址: 端口号)
```
每条TCP连接被唯一的确定：
```
TCP连接::={socket1, socket2} = {(IP1:port1), (IP2:port2)}
```

#### TCP报文的首部
![6d81e90c588df7f2695a787627e505e8.png](/img/ComputerNetworks/计算机网络-TCP的头格式.png)

TCP报文首部各字段的意义：

* 源端口和目的端口：各2字节，源端口号和目的端口号
* 序号和确认号：各4字节，TCP传送的字节流中的每一个字节都按顺序编号了，32位。确认号指的是下一个期待的字节而不是已经正确接收到的最后一个字节。
* 头长度：指明TCP头包含了多少个32位的字（可选字段是变长的，相当于指明了数据部分的起始位置）
* 没有被使用的字段
* 8个1比特的标志位：
    * CWR和ECE用作拥塞控制的信号
    * URG是紧急指针的信号
    * ACK=1表示确认字段是有效的
    * PSH指出这是被推送的数据
    * RST被用于突然重置一个已经变得混乱的连接（主机崩溃等原因造成的）
    * SYN用于建立连接的过程
    * FIN用来释放一个连接
* 窗口：明确指出了现在允许对方发送的数据量
* 校验和：检验的范围包括首部和数据两个部分，和UDP一样计算检验和时要加上12字节的伪首部
* 紧急指针：URG=1时才有意义，指出紧急数据的字节数
* 选项：提供一种添加额外设施的途径，主要针对常规头覆盖不到的方面。可选的有最大报文长度、窗口扩大选项、时间戳选项、选择确认选项等

#### TCP连接的建立和终止
> TCP连接的建立可以称为**三次握手**，终止可以称为**四次握手**

TCP连接的建立：

* 客户端向服务器申请打开某一个端口（SYN=1）
* 服务器端发回一个ACK报文通知客户端请求报文收到
* 客户端收到确认报文以后再次发出确认报文，确认服务器端发出的确认报文
![60ea5337bd22d01ec610204800435a08.png](/img/ComputerNetworks/计算机网络-TCP建立连接.png)
当两端同时请求时，如（b），这时恰好只建立了一个连接。

TCP链接的释放
TCP的连接是全双工的，因此每个方向要单独进行关闭。

* 客户机给服务器一个FIN为1的报文
* 服务器返回一个确认ACK报文
* 服务器发送一个FIN报文
* 客户机回复ACK报文

四次握手后，连接结束。
![2dc49a4c14fa9a75b5a991a998fc4100.png](/img/ComputerNetworks/计算机网络-TCP释放连接.png)

## TCP的流量控制和拥塞控制

#### 流量控制
让发送方的发送速率不要太快，让接收方来得及接受。
利用滑动窗口机制实现对发送方的流量控制。

**滑动窗口：**设置一个窗口起点在未收到ACK的第一个包。

* 正常情况：收到该包的ACK，向后滑一个
* 丢包情况：一直等ACK，同时也把读进缓存的包一起发过去。如果一直等不到ACK，就超时重传。（ACK是要按顺序的，必须等到当前包的ACK收到，才能报后面的ACK发送过去。）

#### 拥塞控制
当提供给任何网络的负载超过了它的处理能力，就会产生拥塞。

**拥塞控制和流量控制的区别：**

* 拥塞控制：防止过多的数据注入网络，使路由器或链路不至过载。拥塞控制所要做的都有一个前提，就是网络能承受现有的网络负荷。
* 流量控制指的是点对点通信量的控制，是端到端的问题。要做的是控制发送端发送数据的速率，使接收端来得及接受。

**几种拥塞控制的方法：**

* 慢开始
* 拥塞避免
* 快速重传
* 快速恢复

## TCP计时器管理
至少使用4个计时器：

* 重传计时器：确认信号到来之前计时器超时，该段被重传
* 坚持计时器：防止死锁
* 保活计时器：一个连接空闲了一段时间后，如果超时，终止连接
* 时间等待计时器：用于连接终止阶段