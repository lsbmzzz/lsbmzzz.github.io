---
layout:     post
title:      Redis总结
subtitle:   Redis总结
date:       2019-10-01
author:     正版慕言
header-img: img/blog_bg_1.jpg
catalog: true
mathjax: true
tags:
    - Redis
    - NoSQL

---

# Redis 缓存

#### 缓存穿透

缓存穿透：当查询一个一定不存在的数据时，一定会先查询缓存，未命中时去查询数据库，若查不到数据则不会写入缓存。这就导致查询不存在的数据时每次请求都会进入数据库查询。

解决方法：用布隆过滤器(bloom filter)过滤掉大量无效查询。

布隆过滤器：在插入元素时，用K个hash函数将元素映射到一个位数组中的K个点，映射到的点设置为1。查询时，只要看这些点是否均为1就能知道它在不在集合中。如果至少有一个为0，那么一定不存在。如果均为1，那么极大可能存在，也可能不存在。

#### 缓存雪崩

缓存雪崩：缓存集中在一段时间失效导致发生大量缓存穿透，使大量查询落在数据库上。

解决方法：
- 使用互斥锁(setnx)：只有获得了锁才能访问数据库，保证同一时刻只有一个请求访问数据库。会造成高延迟。
- 防止过期时间集中：在原有过期时间上加一个随机值
- 二级缓存：设置原始缓存和拷贝缓存，原始缓存有效时间较短，拷贝缓存有效时间较长。原始缓存失效时，可以访问拷贝缓存。在数据一致性要求不高的情况下可以使用。
- 缓存永不过期
    + 物理不过期：不设置缓存时间
    + 逻辑过期：将过期时间存在key对应的value里，如果发现要过期了，通过一个后台异步线程进行缓存构建。

# HyperLogLog

HyperLogLog是基数统计算法，解决去重统计问题。

|命令|功能|
|---|---|
|pfadd|增加计数|
|pfcount|获取计数|
|pfmerge|将多个pf整合在一起形成一个新的pf|

# 管道

客户端允许将多个请求发送给服务器而不需要等待请求回复，在最后一次读取结果即可。主要作用是提高吞吐量。

缺点：

1. 可以提高吞吐量，但无法提供原子性保障
2. 存在相关性依赖的命令不能使用pipeline

# 异步队列

异步队列一般使用list的rpoplpush实现。如果rpop没有消息，sleep一会再重试，以降低CPU占用，提高效率。

**blpop和brpop优化**

由于sleep方法会导致延迟增大，因此使用blpop和brpop(阻塞读)来进行优化。没有数据时会进入睡眠状态，当有数据时，立刻醒过来。

**延时队列**

表示任务需要延时一段时间后执行。

可以通过zset来实现。将value设置为消息任务，score设置为到期时间，通过轮询获取到期消息进行处理。

# Redis架构模式

#### 单机模式

![单机模式](/img/Journal/Redis/Redis单机模式.png)

优点：简单

缺点：内存和处理能力有限，无法高可用。

#### 主从同步

虽然Redis的读写速度快，但也会产生读压力大的情况。为了分担读压力，Redis支持主从复制。

主从结构可以采用一主多从或级联结构。

![Redis的主从结构](/img/Journal/Redis/Redis的主从结构.png)

Redis的主从复制可以根据是否是全量分为全量同步和增量同步。

1. 全量同步一般发生在slave初始化阶段，需要将master上的所有数据复制一份。
- slave连接master，发送SYNC命令
- master接到SYNC，执行BGSAVE生成rdb文档并用缓冲区记录此后执行的所有写命令
- master向所有slave发送快照文件，期间继续记录被执行的写命令
- slave载入快照
- master在发送快照完毕后发送缓冲区中的写命令
- slave完成快照载入，开始接收命令请求和master缓冲区的写命令，并执行
2. 增量同步：指slave开始正常工作后master的写操作同步到slave的过程。master每执行一个写命令就向slave发送相同的写命令，slave执行该写命令。

![Redis主从复制](/img/Journal/Redis/Redis主从复制.png)

优点：降低了master的读压力

缺点：未降低master的写压力，无法高可用

#### 哨兵模式 Sentinel

Sentinel(哨兵)是用来监控redis集群master状态的工具，是Redis高可用解决方案。

哨兵是一个独立的进程，它通过发送命令，等待redis服务器的响应，从而监控运行中的多个redis实例。

哨兵的作用：
- 通过发送命令让redis服务器返回来监控其运行状态(包括master和slave)
- 如果哨兵发现master宕机，会自动将slave切换成master，然后通过发布订阅模式通知其他slave修改配置文件切换主机。

多哨兵模式：用多个哨兵进行监控，同时哨兵之间还会进行监控。

故障切换(failover)的过程：如果一个哨兵检测到master不可用，不会马上failover，而是主观的认为master不可用(主观下线)
；当后面的哨兵也检测到master不可用，并达到一定的值时，哨兵之间会进行一次投票，进行failover操作。切换成功后，通过发布订阅模式让slave切换master(客观下线)。

![Redis哨兵模式](/img/Journal/Redis/Redis哨兵模式.png)

优点：保证了高可用性，可以自动故障迁移

缺点：没有降低master的写压力

#### 集群模式

**一致性哈希：**
- 如果使用普通哈希，在缓存服务器变化时，length字段变化，导致所有缓存数据要重新进行hash运算才能使用。这段时间内如果访问量上升，容易引起雪崩。
- 通过对$mod 2^{32}$的方式保证在增加和删除缓存服务器的情况下其他缓存服务器的缓存仍然可用而不引起雪崩

算法：
1. 将整个哈希空间组织为一个虚拟的圆环($0$ ~ $2^{32} - 1$)
2. 将各个服务器进行哈希，找到其在环上的位置
3. 在访问时，用相同的hash函数计算出哈希值，开始顺时针反向行走，遇到的第一台服务器就是其应该定位到的服务器。

**Redis Cluster**

采用了槽slot的概念分成了16384个槽。Redis集群中内置了16384个哈希槽，当需要在集群中放置一个key-value时，先用CRC16计算出一个结果，然后mod16384放入对应哈希槽。

Redis集群中的节点负责分摊这些slot中的一部分。当动态添加节点或减少节点时，要将16384个槽再分配。

各redis服务器之间通过互相ping-pong判断节点是否可以连接上。如果一半以上的节点ping一个节点时没有回应，就认为该节点宕机了。

如果某个节点发生故障，它负责的slot也就失效了。为了增加可访问性，官方推荐将每一个节点配置成主从结构。

![Redis集群模式](/img/Journal/Redis/Redis集群模式.png)

# 发布与订阅

|命令|功能|
|---|---|
|subscribe|客户端可以订阅一个或多个频道从而成为它们的订阅者。当有其它客户端向被订阅的频道发送消息时，其订阅者都能收到消息。|
|subscribe|客户端可以订阅一个或多个频道从而成为它们的订阅者。当有其它客户端向被订阅的频道发送消息时，其订阅者都能收到消息。|
|psubscribe|客户端订阅一个或多个模式从而成为这些模式的订阅者。当有其它客户端向被订阅的频道发送消息时，不仅会将消息发送给频道订阅者，还会发送给与这个频道相匹配的模式订阅者。|
|unsubscribe|退订某个或某些频道。程序根据被退订频道的名字找到对应的订阅者链表，从中删除退订客户端的信息。如果链表空了，从pubsub_channels里删除对应的键。|
|punsubscribe|退订模式。删除pubsub_patterns里对应的项目|
|public channel message|发送消息给频道。|

频道订阅关系保存在pubsub_channels字典里。

模式订阅关系保存在pubsub_patterns字典里。

# RESP协议

RESP协议是redis客户端和服务端通信的协议。可以用于序列化不同的数据类型，当客户端发送请求时，以字符串数组作为待执行命令的参数。

RESP协议仅用作redis客户端和服务端之间的通信，集群节点之间使用另一种二进制协议进行数据交换。

RESP支持五种数据类型：

- 简单字符串(Simple Strings)，以+开头
```
"+OK\r\n"
```
- 错误数据(Errors)，以-开头
```
"-Error message\r\n"
```
- 整数(Integers)，以:开头
```
:1000\r\
```
- 批量字符串(Bulk Strings)，$+字节数+内容，null用-1表示
```
"$6\r\nfoobar\r\n"
```
- 数组(Arrays)，*+数组个数+数组元素个数+数组+数组元素个数+数组+...
```
"*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n"
```

RESP协议的不同部分使用"rn"分隔

#### RESP的高性能

因为RESP协议中对于批量字符串和数组类型都会通过在内容前面加一个长度标识（prefixed lengths），因此解析的时候，可以根据这些长度标识跳过不关注的字符从而提高解析的性能。